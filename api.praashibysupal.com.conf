# LiteSpeed Virtual Host Configuration for api.praashibysupal.com
# Node.js API Proxy Configuration

docRoot                   $VH_ROOT/public_html
vhDomain                  api.praashibysupal.com
vhAliases                 www.api.praashibysupal.com
adminEmails               admin@praashibysupal.com
enableGzipCompression     1
enableIpGeo               1

errorlog $VH_ROOT/logs/error.log {
  useServer               0
  logLevel                ERROR
  rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
  useServer               0
  logFormat               "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""
  logHeaders              5
  rollingSize             10M
  keepDays                30
}

expires  {
  enableExpires           1
  expiresByType           image/*=A604800,text/css=A604800,application/x-javascript=A604800,application/javascript=A604800,font/*=A604800,application/x-font-ttf=A604800
}

# SSL Configuration
ssl  {
  keyFile                 /usr/local/lsws/conf/cert/api.praashibysupal.com.key
  certFile                /usr/local/lsws/conf/cert/api.praashibysupal.com.crt
  certChain               1
  sslProtocol             24
  ciphers                 EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH:ECDHE-RSA-AES128-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA128:DHE-RSA-AES128-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA128:ECDHE-RSA-AES128-SHA384:ECDHE-RSA-AES128-SHA128:DHE-RSA-AES128-SHA128:DHE-RSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA384:AES128-GCM-SHA128:AES128-SHA128:AES128-SHA128:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4
  enableECDHE             1
}

# Rewrite rules for API
rewrite  {
  enable                  1
  autoLoadHtaccess        1
  rules                   <<<END_rules
RewriteEngine On

# Handle CORS preflight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Proxy all requests to Node.js app on port 5000
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]
END_rules
}

# Script Handler for Node.js (if needed for direct execution)
extprocessor nodejs {
  type                    proxy
  address                 127.0.0.1:5000
  maxConns                100
  initTimeout             60
  retryTimeout            0
  pcKeepAliveTimeout      1
  respBuffer              0
  autoStart               2
  path                    /usr/bin/node
  backlog                 100
  instances               1
  priority                0
  memSoftLimit            2047M
  memHardLimit            2047M
  procSoftLimit           400
  procHardLimit           500
}

# Context for API routes
context /api/ {
  type                    proxy
  addDefaultCharset       off
  extraHeaders            <<<END_extraHeaders
X-Forwarded-Proto: https
X-Forwarded-For: %{REMOTE_ADDR}s
X-Real-IP: %{REMOTE_ADDR}s
END_extraHeaders
  proxyHeaders            1
  addDefaultCharset       off
  extraHeaders            <<<END_extraHeaders
X-Forwarded-Proto: https
X-Forwarded-For: %{REMOTE_ADDR}s
X-Real-IP: %{REMOTE_ADDR}s
END_extraHeaders
}

# Context for uploads directory (static files)
context /uploads/ {
  type                    static
  docRoot                 $VH_ROOT/uploads
  extraHeaders            <<<END_extraHeaders
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
END_extraHeaders
}

# Security headers
extraHeaders              <<<END_extraHeaders
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
Referrer-Policy: strict-origin-when-cross-origin
END_extraHeaders

# Rate limiting (basic)
accessControl  {
  allow                   ALL
  deny                    ALL
}

# Cache control for API responses
cache  {
  enable                  0
  checkPrivateCache       1
  checkPublicCache        1
  maxCacheObjSize         10000000
  maxStaleAge             200
  qsCache                 1
  reqCookieCache          1
  respCookieCache         1
  ignoreReqCacheCtrl      1
  ignoreRespCacheCtrl     0
  enableCache             0
  expireInSeconds         3600
  enablePrivateCache      0
  privateExpireInSeconds  3600
}







